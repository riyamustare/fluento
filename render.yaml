databases:
  - name: fluento-db
    databaseName: fluento
    user: fluento
    plan: free
    region: oregon

services:
  # Redis Instance
  - type: redis
    name: fluento-redis
    plan: free
    region: oregon
    ipAllowList: []

  # Django REST API
  - type: web
    name: fluento-backend
    env: python
    plan: free
    region: oregon
    buildCommand: "pip install -r backend/requirements.txt && cd backend && python manage.py migrate && python manage.py create_levels && python manage.py collectstatic --noinput"
    startCommand: "cd backend && gunicorn core.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --timeout 120"
    healthCheckPath: /api/health/
    envVars:
      - key: PYTHON_VERSION
        value: '3.11.0'
      - key: DJANGO_DEBUG
        value: 'False'
      - key: DJANGO_SECRET_KEY
        generateValue: true
      - key: DJANGO_SETTINGS_MODULE
        value: 'core.settings'
      - key: DATABASE_URL
        fromDatabase:
          name: fluento-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: fluento-redis
          type: redis
          property: connectionString
      - key: DJANGO_ALLOWED_HOSTS
        value: '.onrender.com,localhost,127.0.0.1'
      - key: DJANGO_ENV
        value: 'production'
      - key: CORS_ALLOWED_ORIGINS
        value: 'https://fluentoai.vercel.app,https://fluento-cgbbp9uvs-riyas-projects-602fe862.vercel.app,https://fluento-taupe.vercel.app'
      - key: SECURE_SSL_REDIRECT
        value: 'True'
      - key: SESSION_COOKIE_SECURE
        value: 'True'
      - key: CSRF_COOKIE_SECURE
        value: 'True'

  # FastAPI AI Service
  - type: web
    name: fluento-ai-api
    env: python
    plan: free
    region: oregon
    buildCommand: "pip install -r backend/requirements.txt"
    startCommand: "cd backend/fastapi_service && uvicorn main:app --host 0.0.0.0 --port $PORT --workers 1 --timeout-keep-alive 180"
    healthCheckPath: /health
    envVars:
      - key: PYTHON_VERSION
        value: '3.11.0'
      - key: REDIS_URL
        fromService:
          name: fluento-redis
          type: redis
          property: connectionString
      - key: ASSEMBLYAI_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
